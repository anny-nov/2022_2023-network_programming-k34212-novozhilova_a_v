<p> University: [ITMO University](https://itmo.ru/ru/)
<p> Faculty: [FICT](https://fict.itmo.ru)
<p> Course: [Network programming](https://github.com/itmo-ict-faculty/network-programming) <p>
<p> Year: 2022/2023
<p> Group: K34212
<p> Author: Novozhilova Anna Vladimirovna
<p> Lab: Lab1
<p> Date of create: 17.09.2022
<p> Date of finished: 11.10.2022

<h4>Отчёт о выполнении лабораторной работы</h4>

1. Для создания виртуальной машины, на которой будет размещен OpenVPN сервер, был выбран облачный провайдер Яндекс.Облако, так как на данный момент это один из немногих провайдеров, предоставляющих услуги в России. К тому же, имеется возможность пользоваться им бесплатно 3 месяца. Операционная система созданной машины - Ubuntu 22.04.

2. Так как на машине и так была установлена новейшая версия операционной системы, шаг с обновлением версии до 18той был пропущен. Сразу устанавливаем последнюю версию python и проверяем установку.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/1.png?raw=true" alt="Python installation">

3. Устанавливаем ansible, проверяем установку
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/2.png?raw=true">

4. Кроме виртуальной машины в облаке, которая будет служить сервером, нам также понадобится виртуальная машина на локальном хосте - клиент. Для этого с официального сайта скачиваем образ жесткого диска с операционной системой RouterOS. Я выбрала последнюю доступную стабильную версию.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/3.png?raw=true">

5. При создании виртуальной машины в VirtualBox выбираем скачанный образ в качестве установочного диска, все остальные параметры я не меняла и оставила минимально рекомендованными. При первом входе пользуемся стандартными паролем и логином, указанными на официальном сайте, дальше потребуется изменить пароль. На этом создание виртуальной машины можно считать завершенным. Проверяем также, правильно ли настроена сеть (я выбрала в настройках сетевой мост), для этого пингуем внешний узел.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/4.png?raw=true">

6. Возвращаемся к работе на удаленном хосте. Здесь будет располагаться наш сервер OpenVPN. Я выбрала именно OpenVPN, потому что я использую приложения, работающие на этой технологии в качестве своей основной VPN, так что мне было интересно понять, каким образом это работает. OpenVPN обеспечивает защищенность соединения с помощью SSL сертификатов, так что необходимо установить утилиты как для работы с OpenVPN, так и для работы с сертификатами.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/5.png?raw=true">

7. Также для обеспечения безопасного соединения на сервере должен быть настроен файерволл. Я использую уже предустановленный в систему файерволл ufw. Для корректной передачи трафика нужно открыть такие порты, как 80, 443 (чтобы передавался веб-трафик), 22 (для подключения по ssh) и 993(тут будет располагаться наш туннель). Дальше нужно активировать файерволл.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/6.png?raw=true">

8. В своей работе протокол OpenVPN опирается на работу центра спецификации, которого у нас нет. Значит, перед настройкой сервера нужно создать его. Хорошей практикой является размещение центра сертификации на отдельном хосте, это помогает избежать ряда уязвимостей. Но так как мы настраиваем OpenVPN сервер в учебных целях, я решила опустить этот момент, так как это усложнило бы задачу. Центр сертификации (далее СА - Certificate Authority) будет располагаться на той же машине, что и VPN сервер. Расположим СА в корневой директории OpenVPN. Для этого скопируем туда все файлы из директории
easy-rsa и передадим новое расположение в прееменную EASYRSA. Проинициализируем в этой директории инфраструктуру открытых ключей, на базе которых создадим СА. При создании СА выпускается сертификат, подтверждающий его подлинность.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/7.png?raw=true">

9. Так как сертификатов и ключей к ним будет много, создадим отдельную директорию, где они все будут храниться, и скопируем туда созданный сертификат.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/8.png?raw=true">

10. Для того, чтобы подключающиеся клиенты могли подтвердить подлинность сервера и подключаться через зашифрованное соединение, необходимо выпустить для него сертификат. При выпуске генерируется запрос на подпись сертификатак СА, а также совместимый с ним приватный ключ. Затем запрос передается в СА, и выпускается уже сам сертификат.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/9.png?raw=true">
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/10.png?raw=true">

11. Созданный сертфиикат и его ключ копируются в директорию хранения сертификатов.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/11.png?raw=true">

12. Теперь, когда выпущенны все сертификаты, гарантирующие подлинность и защищенность сервера, необходимо также сгенирировать ключ и сертификат для клиента VPN сервера. Процесс аналогичен тому, что описан в пункте 10, но при подписании сертификата указывается, что он выпущен на клиента.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/14.png?raw=true">

13. Прежде чем запустить сервер, необходимо задать ему желаемую конфигурацию в файле openvpn.conf. Файл с пояснениями к настройкам представлен ниже.

<code>
# Порт для использования
port 993
# TCP/UDP Рекомендуется использовать UDP протокол
proto tcp
;proto udp
# Остается без изменений
;dev tap
dev tun
# Ключи
# Сертификат CA
ca /etc/openvpn/certs/ca.crt
# Сертификат сервера
cert /etc/openvpn/certs/server.crt
# Приватный ключ сервера
key /etc/openvpn/certs/server.key #не распространяется и хранится в секрете
# параметры DH
dh /etc/openvpn/certs/dh2048.pem
# Создание виртуальной сети и ее параметры
# Параметры IP
server 10.8.0.0 255.255.255.0
# При перезагрузке сервера, клиенту будет присвоен прежний IP адрес
ifconfig-pool-persist /etc/openvpn/ipp.txt
# Настройка для установки шлюза по умолчанию (для клиентов при подключении к VPN сервер VPN становится шлюзом)
push "redirect–gateway def1 bypass–dhcp"
# Настройка позволяющая нескольким клиентам использовать одну и #туже пару ключей (сертификат–приватный ключ)
#не рекомендуется для использования, закомментирована
;duplicate–cn
# Пинг удаленного узла с интервалом 10 секунд
# Если не отвечает в течение 120 секунд, считать упавшим
keepalive 10 120
# Защита от DoS–атак портов UDP за счет созданного HMAC файрволла
#remote-cert-tls client
#tls-auth /etc/openvpn/certs/ta.key 0 # файл хранится в секрете
# Криптографические шифры
cipher AES-256-CBC #у клиентов указывается точно такой же
# Сжатие и отправка настроек клиенту
;compress lz4–v2
;push "compress lz4–v2"
# MAX число одновременных подключений
;max–clients 100
# Понижение привилегий демона OpenVPN
# после запуска
# Только для не Windows систем.
;user nobody
;group nobody
# Хранение ключей в памяти (если нет подключения из–за привилегий)
persist-key
persist-tun
# Лог файл текущих соединений.
# Каждую минуту обрезается и перезаписываться
status openvpn–status.log
# Логи syslog.
#!Используется только один. Раскомментировать необходимый.
# перезаписывать файл журнала при каждом запуске OpenVPN
log openvpn.log
# дополнять журнал
;log–append openvpn.log
# Уровень вербальности
#
# 0 тихий, кроме фатальных ошибок
# 4 подходит для обычного использования
# 5 и 6 помогают в отладке при решении проблем с подключением
# 9 крайне вербальный
verb 4
# Предупреждение клиента о перезапуске сервера
;explicit-exit-notify 1
</code>

14. d
