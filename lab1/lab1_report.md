<p> University: [ITMO University](https://itmo.ru/ru/)
<p> Faculty: [FICT](https://fict.itmo.ru)
<p> Course: [Network programming](https://github.com/itmo-ict-faculty/network-programming) <p>
<p> Year: 2022/2023
<p> Group: K34212
<p> Author: Novozhilova Anna Vladimirovna
<p> Lab: Lab1
<p> Date of create: 17.09.2022
<p> Date of finished: 11.10.2022

<h4>Отчёт о выполнении лабораторной работы</h4>

1. Для создания виртуальной машины, на которой будет размещен OpenVPN сервер, был выбран облачный провайдер Яндекс.Облако, так как на данный момент это один из немногих провайдеров, предоставляющих услуги в России. К тому же, имеется возможность пользоваться им бесплатно 3 месяца. Операционная система созданной машины - Ubuntu 22.04.

2. Так как на машине и так была установлена новейшая версия операционной системы, шаг с обновлением версии до 18той был пропущен. Сразу устанавливаем последнюю версию python и проверяем установку.
 <center><image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/1.png?raw=true" alt="Python installation"></center>

3. Устанавливаем ansible, проверяем установку
 <center><image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/2.png?raw=true"></center>

4. Кроме виртуальной машины в облаке, которая будет служить сервером, нам также понадобится виртуальная машина на локальном хосте - клиент. Для этого с официального сайта скачиваем образ жесткого диска с операционной системой RouterOS. Я выбрала последнюю доступную стабильную версию.
 <center><image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/3.png?raw=true"></center>

5. При создании виртуальной машины в VirtualBox выбираем скачанный образ в качестве установочного диска, все остальные параметры я не меняла и оставила минимально рекомендованными. При первом входе пользуемся стандартными паролем и логином, указанными на официальном сайте, дальше потребуется изменить пароль. На этом создание виртуальной машины можно считать завершенным. Проверяем также, правильно ли настроена сеть (я выбрала в настройках сетевой мост), для этого пингуем внешний узел.
 <center><image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/4.png?raw=true"></center>

6. Возвращаемся к работе на удаленном хосте. Здесь будет располагаться наш сервер OpenVPN. Я выбрала именно OpenVPN, потому что я использую приложения, работающие на этой технологии в качестве своей основной VPN, так что мне было интересно понять, каким образом это работает. OpenVPN обеспечивает защищенность соединения с помощью SSL сертификатов, так что необходимо установить утилиты как для работы с OpenVPN, так и для работы с сертификатами.
 <center><image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/5.png?raw=true"></center>

7. Также для обеспечения безопасного соединения на сервере должен быть настроен файерволл. Я использую уже предустановленный в систему файерволл ufw. Для корректной передачи трафика нужно открыть такие порты, как 80, 443 (чтобы передавался веб-трафик), 22 (для подключения по ssh) и 993(тут будет располагаться наш туннель). Дальше нужно активировать файерволл.
 <center><image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/6.png?raw=true"></center>

8. В своей работе протокол OpenVPN опирается на работу центра спецификации, которого у нас нет. Значит, перед настройкой сервера нужно создать его. Хорошей практикой является размещение центра сертификации на отдельном хосте, это помогает избежать ряда уязвимостей. Но так как мы настраиваем OpenVPN сервер в учебных целях, я решила опустить этот момент, так как это усложнило бы задачу. Центр сертификации (далее СА - Certificate Authority) будет располагаться на той же машине, что и VPN сервер. Расположим СА в корневой директории OpenVPN. Для этого скопируем туда все файлы из директории
easy-rsa и передадим новое расположение в прееменную EASYRSA. Проинициализируем в этой директории инфраструктуру открытых ключей, на базе которых создадим СА. При создании СА выпускается сертификат, подтверждающий его подлинность.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/7.png?raw=true">

9. Так как сертификатов и ключей к ним будет много, создадим отдельную директорию, где они все будут храниться, и скопируем туда созданный сертификат.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/8.png?raw=true">

10. Для того, чтобы подключающиеся клиенты могли подтвердить подлинность сервера и подключаться через зашифрованное соединение, необходимо выпустить для него сертификат. При выпуске генерируется запрос на подпись сертификатак СА, а также совместимый с ним приватный ключ. Затем запрос передается в СА, и выпускается уже сам сертификат.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/9.png?raw=true">
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/10.png?raw=true">

11. Созданный сертфиикат и его ключ копируются в директорию хранения сертификатов.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/11.png?raw=true">

12. Теперь, когда выпущенны все сертификаты, гарантирующие подлинность и защищенность сервера, необходимо также сгенирировать ключ и сертификат для клиента VPN сервера. Процесс аналогичен тому, что описан в пункте 10, но при подписании сертификата указывается, что он выпущен на клиента.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/14.png?raw=true">

13. Прежде чем запустить сервер, необходимо задать ему желаемую конфигурацию в файле openvpn.conf. Файл с пояснениями к настройкам представлен в той же директории репозитория. Наиболее важными пунктами здесь являются port - порт, на котором будет открыт VPN туннель, proto - протокол, который будет использоваться для передачи данных. Тут необходимо установить tcp, так как mikrotik не поддерживает udp соединение. server - адрес и маска сети VPN. cipher - алгоритм, которым будут зашифрованы данные, очень важно указать на клиенте такой же.

14. Проводим тестовый запуск OpenVPN сервера. Если команда не выдала ошибок, значит настройка сервера выполнена верно (по крайней мере без оглядки на ограничения клиентов). В логах должна появиться строчка Initialization Sequence Completed.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/15.png?raw=true">
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/16.png?raw=true">

15. Теперь можно запустить непосредственно сервис, отвечающий за OpenVPN, и установить его на автоматическую загрузку при старте системы
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/17.png?raw=true">

16. Сервер поднят, однако сейчас на нем не выполняется маршрутизация трафика, поэтому доступ будет только в пределах локальной сети. Для подлкючения маршрутизации создадим скрипт. Содержание скрипта также представлено в репозитории. Он подключает маршрутизацию IP-пакетов, а также настраивает iptables таким образом, что во всех уходящие пакетах на выбранном внешнем интерфейсе (если интерфейс не был выбран, программа выберет его сама) будет осуществляться подмена адресов.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/18.png?raw=true">

17. Осуществляем тестовый запуск скрипта.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/19.png?raw=true">

18. Чтобы скрипт не нужно было запускать вручную при перезагрузке системы, создадим службу, ответственную за запуск этого скрипта, и установим ее на автозагрузку.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/20.png?raw=true">

19. На этом настройка сервера завершена, можно переходить к настройке клиента. Первым делом необходимо подключиться к веб-интерфейсу нашего виртуального маршрутизатора. Для этого сначала узнаем его адрес через консоль, а затем просто переходим по нему и авторизируемся.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/21.png?raw=true">

20. В веб-интерфейсе переходим во вкладку files и подгружаем туда сертификат и ключ клиента, а также сертификат центра сертификации.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/22.png?raw=true">

21. Сейчас машина видит их только как файлы, так что необходимо указать ей, что это именно сертификат. Для этого переходим во вкладку System -> Certificates и с помощью кнопки Import указываем на сертификаты. Важно, чтобы рядом с сертификатом клиента стояли буквы ТК. Это значит, что для сертификата есть подходящий ключ.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/23.png?raw=true">

22. Затем переходим на вкладку PPP и выбираем здесь Add New -> OpenVPN Client.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/24.png?raw=true">

23. В открывшемся окне указываем имя подключения, порт и адрес сервера, к которому будем подключаться, алгоритмы шифрования и аутентификации, сертификат клиента. Все остальное можно оставить без изменений.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/25.png?raw=true">

24. Проверяем в логах, как на клиенте, так и на сервере, что подключение прошло успешно и сервер внес маршрутизатор в список клиентов и выдал ему внутренний адрес.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/26.png?raw=true">
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/27.png?raw=true">

25. Также по графику работы интерфейса можем видеть, что трафик через него идет.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/28.png?raw=true">

26. Осталось только проверить IP-связность устройств. Для этого пингуем сервер с клиента и клиента с сервера. Видим, что пинги доходят до получателя.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/29.png?raw=true">
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab1/img/30.png?raw=true">

**Выводы**: по результатам выполнения лабораторной работы имеется виртуальная машина с установленной системой контроля конфигураций Ansible в облачном сервисе и локальная вирутальная машина с установленной на ней RouterOS в VirtualBox. Между сервером в облаке и клиентом на локальном хосте установлено безопасное соединение через VPN туннель на базе протокола OpenVPN. Достигнута IP-связность хостов.
