<p> University: [ITMO University](https://itmo.ru/ru/)
<p> Faculty: [FICT](https://fict.itmo.ru)
<p> Course: [Network programming](https://github.com/itmo-ict-faculty/network-programming) <p>
<p> Year: 2022/2023
<p> Group: K34212
<p> Author: Novozhilova Anna Vladimirovna
<p> Lab: Lab1
<p> Date of create: 8.12.2022
<p> Date of finished: 10.12.2022

<h4>Отчёт о выполнении лабораторной работы</h4>

Цель работы: Изучить синтаксис языка программирования P4 и выполнить 2 задания обучающих задания от Open network foundation для ознакомления на практике с P4.

1. С помощью Vagrant была поднята виртуальная машина со всеми настройками, необходимыми для выполнения работы.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/1.png?raw=true">

2. Был произведен вход в виртуальную машину под пользователем p4.

3. В первом задании необходимо было дописать программу, реализующую перенаправление пакетов между коммутаторами, находящимися в разных сегментах сети. С помощью консольной команды make run была эмулирована сеть, соответствующая представленной диаграмме.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/16.png?raw=true">

4. По умолчанию все коммутаторы просто сбрасывают все приходящие к ним пакеты, и, соответственно, запросы пинга не получают ответов ни с одного коммутатора.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/2.png?raw=true">

5. В самом начале программы были объявлены все используемые типы данных и структуры. Поля заголовков ethernet_t и ipv4_t соответствуют реальным полям заголвков пакетов. Оба заголовка были объединены в структуру headers.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/4.png?raw=true">

6. Парсер в P4 предназначен для преобразования данных из поступающих пакетов, написанных на языке конечного автомата, в читаемые данные. Написанный в ходе выполнения задания парсер имеет три возможных состояния: start, parse_ethernet и parse_ipv4. Состояние start наступает при получении пакета и переводит парсер в состояние обработки Ethernet-пакета. Пакет распаковывается, и дальше либо парсер переводится в состояние распаковки IPv4-пакета, либо пакет просто принимается и не идет дальше.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/5.png?raw=true">

7. Раздел Ingress Processing содержит методы, необходимые для обработки пакета на плане управления. Есть таблица маршрутизации ipv4_lpm (статические маршруты для нее прописаны в отдельном файле), которая содержит три действия: сбросить пакет, передать пакет и ничего не сделать (действие по умолчанию). В ходе работы был дополнен метод, отвечающий за передачу пакетов. В случае если пакет необходимо передать, на порт выхода назначается число, переданное в метод, адрес назначения подменяется на новый, а адрес источника - на предыдущий адрес назначения, убавляется значение TTL. Также в этом разделе реализована проверка правильности IP-адреса.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/6.png?raw=true">

8. Последние изменение в программу вносилось в раздел депарсера. Этот раздел отвечает за обратное преобразование пакетов в данные, понятные машине. Сначала запаковывается Ethernet-пакет, а затем IPv4-пакет.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/7.png?raw=true">

9. В результате повторного запуска эмуляции сети все коммутаторы получили возможность связываться друг с другом.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/3.png?raw=true">

10. Во втором задании перенаправление пакетов уже реализовано в шаблоне программы. Необходимо было дополнить шаблон таким образом, чтобы была возможность осуществлять туннелирование между всеми коммутаторами в сети, представленной на диаграмме ниже.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/17.png?raw=true">

11. В этом шаблоне присутствует новый заголовок myTunnel, состоящий из идентификатора протокола и идентификатора коммутатора, на который нужно отправить пакет. Заголовок добавлен в структуру headers.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/12.png?raw=true">

12. В парсер было добавлено новое состояние, преобразующее туннельный заголовок. Если идентификатор протокола соответствует IPv4, парсер переходит в состояние преобразования IP-пакета, по умолчанию - просто принимает пакет.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/13.png?raw=true">

13. В разделе Ingress Processing добавлена новая таблица, в которой будут хранится записи о маршрутах туннелирования. В качестве ключа она ищет точное соответсвие для dest_id. В таблице доступны действия перенаправления пакета на нужный порт myTunnel_forward и отбрасывания пакета по умолчанию. Также перед проверкой соответствия заголовка IPv4, добавлена проверка заголовка myTunnel.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/14.png?raw=true">

14. В депарсере пакеты туннелирования преобразуются после Ethernet-пакетов, но до IPv4-пакетов.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/15.png?raw=true">

15. Для проверки в эмуляторе были открыты консоли первого и второго коммутаторов.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/8.png?raw=true">

16. Первым делом был отправлен пакет без данных, необходимых заголовку туннелирования. Итоговый пакет дошел до адресата и содержал заголовки TCP, Ethernet, IPv4 и непосредственно переданное сообщение.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/9.png?raw=true">

17. Затем к сообщению были добавлены данные для заголовка туннелирования - dst_id, соответствующий второму коммутатору. Пакет также дошел до адресата и содержал дополнительный заголовок MyTunnel.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/10.png?raw=true">

18. Последним был отправлен пакет на IP-адрес третьего коммутатора, но при этом указан dst_id второго коммутатора. Пакет не дошел до отправителя и ушел на второй коммутатор, потому что при наличии корректного заголовка myTunnel реализуется таблица маршрутизации myTunnel_exact, и IP-адрес при этом не имеет значения.
<image src="https://github.com/anny-nov/2022_2023-network_programming-k34212-novozhilova_a_v/blob/main/lab4/img/11.png?raw=true">

Выводы: Были узчены основы языка программирования P4, предназначенные для организации процесса обработки сетевого трафика. Полученные знания применены на практике, написано 2 программы, позволяющие организовать в заранее созданной сети процессы перенаправления пакетов и туннелирования.
